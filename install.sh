#!/usr/bin/env bash

export DOTFILES="$(pwd)"

case "$(uname -a)" in
    Linux*microsoft-standard-WSL2*) export DOTFILES_OS="wsl" ;;
    Linux*) export DOTFILES_OS="linux" ;;
    Darwin*) export DOTFILES_OS="mac" ;;
    MINGW*) export DOTFILES_OS="windows" ;;
    *) export DOTFILES_OS="unknown" ;;
esac

if [[ ! -f "$HOME/.config/mbromell/env.sh" ]]; then
    mkdir -p "$HOME/.config/mbromell"
    env_file="$HOME/.config/mbromell/env.sh"

    # Setting config vars
    echo "# WARNING: DO NOT EDIT THIS FILE" >$env_file
    echo "# Auto-generated from $DOTFILES/install.sh" >>$env_file
    echo "export DOTFILES=\"$DOTFILES\"" >>$env_file
    echo "export DOTFILES_OS=\"$DOTFILES_OS\"" >>$env_file
else
    source "$HOME/.config/mbromell/env.sh"
fi

# Do Windows stuff and get out of the way
if [[ "$DOTFILES_OS" == "windows" ]]; then
    mkdir -p \
        "$HOME/.config/wezterm/" \
        "$HOME/.config/intel/" \
        "$HOME/.config/mbromell/" \
        "$HOME/.config/nvim/" \
        "$HOME/AppData/Local/nvim/"
    rsync -av "$DOTFILES/home/wezterm/.config/" "$HOME/.config/"
    rsync -av "$DOTFILES/home/git/" "$HOME/"
    rsync -av "$DOTFILES/home/intel/.config/" "$HOME/.config/"
    rsync -av "$DOTFILES/home/mbromell/.config/" "$HOME/.config/"
    rsync -av "$DOTFILES/home/nvim/.config/" "$HOME/.config/"
    rsync -av "$DOTFILES/home/nvim/.config/nvim/" "$HOME/AppData/Local/nvim/"
    exit 0
fi

function stow_helper() {
    stow_dir="$1"
    stow_files="$(ls $DOTFILES/${stow_dir}/ | tr "\n" " ")"
    pushd $DOTFILES/${stow_dir}/
    for dir in $stow_files; do
        echo "[+] Stowing :: $dir"
        # Ignore pointless bug warnings
        # https://github.com/aspiers/stow/issues/65#issuecomment-1465060710
        stow -t $HOME -D $dir \
            2> >(grep -v -E 'BUG in find_stowed_path|perl:|LANG|LC_ALL|are supported' 1>&2)
        stow -t $HOME $dir \
            2> >(grep -v -E 'BUG in find_stowed_path|perl:|LANG|LC_ALL|are supported' 1>&2)
    done
    popd
}

stow_helper home
[[ "$DOTFILES_OS" == "wsl" ]] && stow_helper home-wsl

"$DOTFILES/scripts/setup-nvim.sh"
