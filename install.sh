#!/usr/bin/env bash

if [[ -d "${HOME}/dotfiles" ]]; then
    echo "[ERROR] It seems dotfiles have already been installed."
    echo "[+] Remove your existing ${HOME}/dotfiles if you wish to install"
    echo "[+] https://github.com/mbromell/dotfiles"
    exit 1
fi

case "$(uname)" in
    Linux*)             dotfiles_env="linux" ;;
    Linux*Microsoft*)   dotfiles_env="wsl" ;;
    Darwin*)            dotfiles_env="mac" ;;
    *)                  dotfiles_env="unknown" ;;
esac

if [[ "$dotfiles_env" == "unknown" ]]; then
    echo "[ERROR] Unkown OS environment of: $(uname)"
    echo "[+] Exiting install as to not cause any damage."
    exit 1
fi

# Setting config vars
echo "# WARNING: DO NOT EDIT THIS FILE" > $HOME/.dotrc
echo "# Auto-generated from $HOME/dotfiles/install.sh" >> $HOME/.dotrc
echo "export DOTFILES=\"$HOME/dotfiles\"" >> $HOME/.dotrc
echo "export DOTFILES_ENV=\"${dotfiles_env}\"" >> $HOME/.dotrc
source $HOME/.dotrc

if ! command -v nix-env &> /dev/null; then
    echo "[+] Installing nix package manager for nix-env"
    if [[ "$DOTFILES_ENV" == "mac" ]]; then
        sh <(curl -L https://nixos.org/nix/install) --yes
    else
        sh <(curl -L https://nixos.org/nix/install) --yes --daemon
    fi
    # Restart shell after install.
    $SHELL -l
fi

echo "[+] Installing git"
nix-env -iA nixpkgs.git
echo "[+] Installing stow"
nix-env -iA nixpkgs.stow

echo "[+] Cloning dotfiles repo to $HOME/dotfiles"
git clone https://github.com/mbromell/dotfiles.git $HOME/dotfiles

if ! command -v zsh &> /dev/null; then
    echo "[+] Installing zsh"
    nix-env -iA nixpkgs.zsh
fi

if [[ "$SHELL" != "zsh" ]]; then
    echo "[+] Setting ZSH as default shell"
    chsh -s $(which zsh)
fi

if [[ ! -z "${ZSH}" ]]; then
    echo "[+] Installing oh-my-zsh"
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
fi

# Install brew casks for mac
if [[ "$DOTFILES_ENV" == "mac" ]]; then
    if ! command -v brew &> /dev/null; then
        echo "[+] Installing Homebrew"
        NONINTERACTIVE=1 bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        echo "[+] Installing brew cask 'alt-tab', 'iterm2'"
        brew install --cask alt-tab iterm2 linearmouse usr-sse2-rdm
    fi
fi

source $DOTFILES/dotfiles/.config/dotfiles/functions.sh
dotstow
dotnix
