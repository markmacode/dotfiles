#!/usr/bin/env bash

case "$(uname -a)" in
    Linux*microsoft-standard-WSL2*) export OS="wsl" ;;
    Linux*) export OS="linux" ;;
    Darwin*) export OS="mac" ;;
    MINGW*) export OS="windows" ;;
    *) export OS="unknown" ;;
esac

if [[ ! -f $HOME/.config/mbromell/env.sh ]]; then
    mkdir -p $HOME/.config/mbromell
    env_file=$HOME/.config/mbromell/env.sh

    # Setting config vars
    echo "# WARNING: DO NOT EDIT THIS FILE" >$env_file
    echo "# Auto-generated from $DOTFILES/install.sh" >>$env_file
    echo "export DOTFILES=\"$DOTFILES\"" >>$env_file
else
    source $HOME/.config/mbromell/env.sh
fi

# Do Windows stuff and get out of the way
if [[ "$OS" == "windows" ]]; then
    rsync -av $DOTFILES/home/wezterm/.config/ $HOME/.config/
    rsync -av $DOTFILES/home/git/ $HOME/
    rsync -av $DOTFILES/home/intel/.config/ $HOME/.config/
    exit 0
fi

stow_files="$(ls $DOTFILES/home/ | tr "\n" " ")"

pushd $DOTFILES/home
for dir in $stow_files; do
    echo "[+] Stowing :: $dir"
    # Ignore pointless bug warnings
    # https://github.com/aspiers/stow/issues/65#issuecomment-1465060710
    stow -t $HOME -D $dir \
        2> >(grep -v 'BUG in find_stowed_path? Absolute/relative mismatch' 1>&2)
    stow -t $HOME $dir
done
popd

$DOTFILES/scripts/setup-nvim.sh
